name: Bug Fix Automation

on:
  workflow_dispatch:
    inputs:
      jira_issue_key:
        description: 'Jira Issue Key (e.g., BAP-1)'
        required: true
        type: string

env:
  PYTHON_VERSION: '3.11'

jobs:
  analyze-and-fix-bug:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Get Jira issue details
        id: jira
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          ISSUE_KEY: ${{ github.event.inputs.jira_issue_key }}
        run: |
          python - <<'EOF'
          import os
          import requests
          from requests.auth import HTTPBasicAuth
          
          jira_url = os.environ['JIRA_BASE_URL']
          email = os.environ['JIRA_USER_EMAIL']
          api_token = os.environ['JIRA_API_TOKEN']
          issue_key = os.environ['ISSUE_KEY']
          
          url = f"{jira_url}/rest/api/3/issue/{issue_key}"
          auth = HTTPBasicAuth(email, api_token)
          headers = {"Accept": "application/json"}
          
          response = requests.get(url, headers=headers, auth=auth)
          
          if response.status_code == 200:
              issue = response.json()
              summary = issue['fields']['summary']
              description = issue['fields']['description']['content'][0]['content'][0]['text'] if issue['fields'].get('description') else ''
              
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"issue_key={issue_key}\n")
                  f.write(f"summary={summary}\n")
                  f.write(f"description<<EOF\n{description}\nEOF\n")
              
              print(f"âœ… Fetched Jira issue: {issue_key}")
              print(f
